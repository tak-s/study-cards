{% extends "base.html" %}

{% block title %}{{ dataset_name }} クイズ練習 - StudyCards{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-brain"></i> {{ dataset_name }} クイズ練習</h1>
            <div>
                <a href="{{ url_for('generate_quiz', filename=filename) }}" class="btn btn-outline-primary me-2">
                    <i class="fas fa-file-pdf"></i> PDF生成
                </a>
                <a href="{{ url_for('edit_dataset', filename=filename) }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 戻る
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        {% if total_items == 0 %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h4 class="text-warning">データが不足しています</h4>
                <p class="text-muted">クイズを開始するためには、最低1つのアイテムが必要です。</p>
                <a href="{{ url_for('edit_dataset', filename=filename) }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> アイテムを追加
                </a>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> クイズ設定</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('start_quiz', filename=filename) }}">
                    <div class="mb-4">
                        <label for="num_questions" class="form-label">問題数</label>
                        <input type="number" class="form-control" id="num_questions" name="num_questions" 
                               value="10" min="1" max="{{ total_items }}" required>
                        <div class="form-text">
                            利用可能なアイテム数: {{ total_items }}件
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">問題タイプ</label>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <div class="card">
                                    <div class="card-body">
                                        <input type="radio" class="form-check-input" id="question_to_answer" 
                                               name="quiz_type" value="question_to_answer" checked>
                                        <label class="form-check-label w-100" for="question_to_answer">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">質問 → 回答</h6>
                                                    <small class="text-muted">質問を見て回答を入力</small>
                                                </div>
                                                <i class="fas fa-arrow-right text-primary"></i>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <input type="radio" class="form-check-input" id="answer_to_question" 
                                               name="quiz_type" value="answer_to_question">
                                        <label class="form-check-label w-100" for="answer_to_question">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">回答 → 質問</h6>
                                                    <small class="text-muted">回答を見て質問を入力</small>
                                                </div>
                                                <i class="fas fa-arrow-left text-success"></i>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">出題モード</label>
                        <div class="row">
                            <div class="col-12 mb-2">
                                <div class="card">
                                    <div class="card-body">
                                        <input type="radio" class="form-check-input" id="random_mode" 
                                               name="focus_mode" value="random" checked>
                                        <label class="form-check-label w-100" for="random_mode">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">ランダム出題</h6>
                                                    <small class="text-muted">全ての問題からランダムに出題</small>
                                                </div>
                                                <i class="fas fa-random text-info"></i>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <input type="radio" class="form-check-input" id="focus_mode" 
                                               name="focus_mode" value="low_proficiency">
                                        <label class="form-check-label w-100" for="focus_mode">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">習熟度重視</h6>
                                                    <small class="text-muted">習熟度の低い問題を優先的に出題</small>
                                                </div>
                                                <i class="fas fa-target text-warning"></i>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-play"></i> クイズを開始
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> インタラクティブクイズについて</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li><strong>習熟度管理:</strong> 正解・不正解が記録され、習熟度が自動計算されます</li>
                    <li><strong>効率的学習:</strong> 習熟度重視モードで苦手分野を集中的に練習できます</li>
                    <li><strong>進捗確認:</strong> データセット編集画面で習熟度を視覚的に確認できます</li>
                    <li><strong>データ保存:</strong> 習熟度データはCSVエクスポート・インポートに含まれます</li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const radioButtons = document.querySelectorAll('input[type="radio"]');
    const cards = document.querySelectorAll('.card .card-body');
    
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            // すべてのカードのスタイルをリセット
            cards.forEach(card => {
                if (card.querySelector('input[type="radio"]')) {
                    card.parentElement.style.borderColor = '';
                    card.parentElement.style.backgroundColor = '';
                }
            });
            
            // 選択されたカードをハイライト
            const selectedCard = this.closest('.card');
            selectedCard.style.borderColor = '#0d6efd';
            selectedCard.style.backgroundColor = '#f8f9ff';
        });
    });
    
    // 初期選択状態を設定
    const checkedRadios = document.querySelectorAll('input[type="radio"]:checked');
    checkedRadios.forEach(radio => {
        const selectedCard = radio.closest('.card');
        selectedCard.style.borderColor = '#0d6efd';
        selectedCard.style.backgroundColor = '#f8f9ff';
    });
    
    // 問題数の自動調整
    const numQuestionsInput = document.getElementById('num_questions');
    const maxQuestions = parseInt('{{ total_items }}');
    
    numQuestionsInput.addEventListener('input', function() {
        if (parseInt(this.value) > maxQuestions) {
            this.value = maxQuestions;
        }
        if (parseInt(this.value) < 1) {
            this.value = 1;
        }
    });
});
</script>
{% endblock %}